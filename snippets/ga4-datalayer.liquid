<script>
  window.dataLayer = window.dataLayer || [];

  window.pushEcommerceEvent = function(eventName, payload) {
    payload = payload || {};

    var currency = payload.currency || '{{ shop.currency }}';
    var value    = payload.value || 0;
    var items    = payload.items || [];

    var ga4Items = items.map(function(item, index) {
      return {
        item_id: item.item_id || item.id || item.sku || null,
        item_name: item.item_name || item.name || null,
        item_brand: item.item_brand || item.brand || '{{ shop.name | escape }}',
        item_category: item.item_category || item.category || undefined,
        item_variant: item.item_variant || item.variant_name || undefined,
        quantity: Number(item.quantity || 1),
        price: Number(item.price || 0),
        index: index + 1
      };
    });

    // Clear previous ecommerce object
    window.dataLayer.push({ ecommerce: null });

    // Base event object
    var eventObject = {
      event: eventName,
      ecommerce: {
        currency: currency,
        value: value,
        items: ga4Items,
        transaction_id: payload.transaction_id,
        coupon: payload.coupon,
        affiliation: payload.affiliation,
        tax: payload.tax,
        shipping: payload.shipping,
        discount: payload.discount
      }
    };

    // Optional extra metadata (top-level)
    if (payload.event_source) {
      eventObject.event_source = payload.event_source;
    }
    if (payload.event_category) {
      eventObject.event_category = payload.event_category;
    }
    if (payload.event_label) {
      eventObject.event_label = payload.event_label;
    }

    window.dataLayer.push(eventObject);
  };
</script>

