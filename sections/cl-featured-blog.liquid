{% comment %}
  CL Author Blog Grid – HANDLE MATCHING (final)
  • Compares Author **handle** (unique + always present) between the page’s
    metaobject and each article’s Author metafield.
  • Iterates correctly over blogs via handles.
  • Debug mode shows per‑blog handle matches and total.
{% endcomment %}

{{ 'component-article-card.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'section-main-blog.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding{padding-top:{{ section.settings.padding_top | times:0.75 | round:0 }}px;padding-bottom:{{ section.settings.padding_bottom | times:0.75 | round:0 }}px}
  @media(min-width:750px){.section-{{ section.id }}-padding{padding-top:{{ section.settings.padding_top }}px;padding-bottom:{{ section.settings.padding_bottom }}px}}
  .debug-block{background:#fdf6e3;border:1px dashed #b58900;padding:1rem;margin:1rem 0;font-family:monospace;font-size:.85rem;white-space:pre-wrap}
{%- endstyle -%}

{%- assign current_author = metaobject -%}
{%- assign author_handle = current_author.handle -%}

{%- assign articles_by_author = '' | split: ',' -%}

{%- if section.settings.debug_mode -%}<div class="debug-block">DEBUG — Author handle: "{{ author_handle }}"</div>{%- endif -%}

{%- for blog_handle in blogs -%}
  {%- assign blog_obj = blogs[blog_handle] -%}
  {%- if blog_obj -%}
    {%- assign found = 0 -%}
    {%- for art in blog_obj.articles -%}
      {%- assign art_author = art.metafields.blog_post.author.value -%}
      {%- if art_author and art_author.handle == author_handle -%}
        {%- assign articles_by_author = articles_by_author | concat: [art] -%}
        {%- assign found = found | plus: 1 -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if section.settings.debug_mode -%}<div class="debug-block">Blog "{{ blog_obj.title }}" ⇒ handle matches: {{ found }}</div>{%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- if section.settings.debug_mode -%}<div class="debug-block">TOTAL collected via handle: {{ articles_by_author.size }}</div>{%- endif -%}

{%- if articles_by_author.size == 0 -%}
  <div class="page-width section-{{ section.id }}-padding"><p>{{ current_author.name | default: author_handle | escape }} has not published any articles yet.</p></div>
{%- else -%}
  {%- assign articles_by_author = articles_by_author | sort: 'published_at' | reverse -%}
  {%- paginate articles_by_author by 6 -%}
    <div class="main-blog page-width section-{{ section.id }}-padding">
      <h1 class="title--primary">{{ current_author.name | default: author_handle | escape }}</h1>
      <div class="blog-articles{% if section.settings.layout == 'collage' %} blog-articles--collage{% endif %}">
        {%- for article in paginate.items -%}
          <div class="blog-articles__article article">
            {%- render 'cl-article-card', article: article, media_height: section.settings.image_height, media_aspect_ratio: article.image.aspect_ratio, show_image: section.settings.show_image, show_date: section.settings.show_date, show_author: section.settings.show_author, show_excerpt: true -%}
          </div>
        {%- endfor -%}
      </div>
      {%- if paginate.pages > 1 -%}{% render 'pagination', paginate: paginate %}{%- endif -%}
    </div>
  {%- endpaginate -%}
{%- endif -%}

{% schema %}
{
  "name": "CL Author Blog Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {"type":"checkbox","id":"debug_mode","label":"Enable debug information","default":false},
    {"type":"select","id":"layout","options":[{"value":"grid","label":"Grid"},{"value":"collage","label":"Collage"}],"default":"grid","label":"Layout"},
    {"type":"checkbox","id":"show_image","label":"Show images","default":true},
    {"type":"select","id":"image_height","options":[{"value":"adapt","label":"Adapt"},{"value":"small","label":"Small"},{"value":"medium","label":"Medium"},{"value":"large","label":"Large"}],"default":"medium","label":"Image height"},
    {"type":"checkbox","id":"show_date","label":"Show date","default":true},
    {"type":"checkbox","id":"show_author","label":"Show author","default":false},
    {"type":"range","id":"padding_top","label":"Padding top","min":0,"max":100,"step":4,"unit":"px","default":64},
    {"type":"range","id":"padding_bottom","label":"Padding bottom","min":0,"max":100,"step":4,"unit":"px","default":64}
  ],
  "presets":[{"name":"CL Author Blog Grid"}]
}
{% endschema %}
